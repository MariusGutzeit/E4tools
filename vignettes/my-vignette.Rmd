---
title: "Using E4tools to process EDA data"
author: "Evan Kleiman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(E4tools)
```
This vignette can be used demonstration data that are already in the correct folder strucutre. You can download it here [on our lab's website](https://kleimanlab.org/e4tools/). Download the ZIP file on the page and unzip it. But, do not unzip any of the zip files within subfolders.

## Step 0: Structure your files
Your files should be structured in a way such that you have one main folder that contains within in, a subfolder for each participant. The name of each participant folder should be their ID number. In each "participant" subfolder should be all zip files containing their data, using the naming convention that E4 Connect uses (starttime_serialnumber.zip). 

## Step 1: Extract and filter raw EDA
This step is where you extract and filter EDA data. It will output raw data, filtered data (using user-specified high and low pass filters + a butterworth filter), and filtered + feature-scaled ([0,1]) data. It will also provide summary data at the participant and session level.

Inputs: (1) List of participant numbers and (2) location where ZIP folders are stored. 

Outputs: (1) one RDS file per participant with all data, (2) summary file that gives participant-level meta-data.

#### Code
```{r} 
E4_EDA_Process.part1.ExtractRawEDA(participant_list=c(1001:1003),
                                   ziplocation="~/Documents/E4tools_demo_data/data/",
                                   rdslocation.EDA="~/Documents/E4tools_demo_data/output/raw_EDA/",
                                   summarylocation="~/Documents/E4tools_demo_data/output/summaries/",
                                   EDA_low_cut=0.001,LowPctCutoff=.75,
                                   EDA_high_cut=25,HighPctCutoff=.75)

```

#### Sample of RDS output file
```{r, echo=FALSE}
options(scipen = 999)
RDS_data<-readRDS("~/Documents/E4tools_demo_data/output/raw_EDA/1002_EDA.rds")
RDS_output1<-(head(RDS_data))
knitr::kable(RDS_output1, format = "html")
```

## Step 2: Extract button presses
This steps is where  you extract button presses and remove presses that are within a certain number of minutes before the end of a session or that are too close to another button press. If the participant has not pressed the button at all, it will give you a warning and continue with the other participants.

Inputs: (1) List of participant numbers, (2) Location where ZIP folders are stored. 

Output (one file per study): RDS file with list of IDs and button press times.

#### Code

```{r}
E4_EDA_Process.part2.ExtractButtonPresses(participant_list=c(1001:1003),
                                          ziplocation="~/Documents/E4tools_demo_data/data/",
                                          rdslocation.buttonpress="~/Documents/E4tools_demo_data/output/tags/",
                                          part1summaries="~/Documents/E4tools_demo_data/output/summaries/",
                                          cutoff.ends=2,
                                          cutoff.overlap=20)
```


#### Sample of RDS output file
```{r, echo=FALSE}
ButtonPresses<-readRDS("~/Documents/E4tools_demo_data/output/tags/button_presses.RDS")
ButtonPresses1<-head(ButtonPresses)
knitr::kable(ButtonPresses1, format = "html")
```



## Step 3: Match button presses to EDA
This function allows you to extract the data that are within X minutes before and/or after a button press. If there are no button pressess for a participant, it will issue a warning and continue with the next participant.
Inputs: (1) List of participant numbers, (2) location of individual EDA files from step 1, (3) location of button presses from step 2.
Outputs: (1) RDS file with EDA data before and/or after button presses (and control data), for each participant and combined.

#### Code

```{r}
E4_EDA_Process.part3.MatchPressesToEDA(participant_list=c(1001:1003),
                                       rdslocation.buttonpress="~/Documents/E4tools_demo_data/output/tags/",
                                       rdslocation.MatchedEDA="~/Documents/E4tools_demo_data/output/matched_EDA/",
                                       rdslocation.EDA="~/Documents/E4tools_demo_data/output/raw_EDA/",
                                       min.before=20,min.after=20,control=T)
```

#### Sample of RDS output file
```{r, echo=FALSE}
MatchedData<-readRDS("~/Documents/E4tools_demo_data/output/matched_EDA/EDA_presses_COMBINED.RDS")
MatchedData1<-head(MatchedData)
knitr::kable(MatchedData1, format = "html")
```

## Step 4: Put matched EDA in to bins

```{r}
E4_EDA_Process.part4.BinMatchedEDA(participant_list=c(1001:1003),
                                   rdslocation.MatchedEDA="~/Documents/E4tools_demo_data/output/matched_EDA/",
                                   min.after = 20,min.before = 20,
                                   rdslocation.BinnedMatchedEDA="~/Documents/E4tools_demo_data/output/")
```
#### Sample of RDS output file
Note: The values for "MinBeforeAfter" for "before" values will be negative, to facilate things like growth curve modeling. If you positive integers, just multiple this column by -1.
```{r, echo=FALSE}
MergedData<-readRDS("~/Documents/E4tools_demo_data/output/EDA_merged_binned.RDS")
MergedData1<-head(MergedData)
knitr::kable(MergedData1, format = "html")
```
